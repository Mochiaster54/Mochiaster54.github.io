<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChanBoard - Anónimo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #eef2ff;
            color: #000;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #800080;
            color: white;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: bold;
        }
        
        .post-form {
            background-color: #d6daf0;
            border: 1px solid #b7c5d9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #b7c5d9;
            border-radius: 4px;
            background-color: white;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #800080;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #6a006a;
        }
        
        .thread {
            background-color: #d6daf0;
            border: 1px solid #b7c5d9;
            margin-bottom: 20px;
            border-radius: 4px;
            padding: 15px;
        }
        
        .post {
            background-color: white;
            border: 1px solid #b7c5d9;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .post-header {
            color: #117743;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .post-content {
            margin-bottom: 10px;
        }
        
        .post-image {
            max-width: 200px;
            max-height: 200px;
            margin: 5px 0;
        }
        
        .replies {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .reply-form {
            margin-top: 10px;
            padding: 10px;
            background-color: #eef2ff;
            border-radius: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: red;
            background-color: #ffd6d6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .success {
            color: green;
            background-color: #d6ffd6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <p>token: ghp_KKmFfhezNvJaIvrCHBV9ufOWBWaQ1i0HFcW</p><p>v</p>
    <p>gits: 249dd1417f372f7a170eaf6f8e058cf2</p>
    <header>
        <div class="header-content">
            <h1>ChanBoard - Publicaciones anónimas</h1>
        </div>
    </header>
    
    <div class="container">
        <div id="message"></div>
        
        <div class="post-form">
            <h3>Nuevo Hilo</h3>
            <div class="form-group">
                <input type="text" id="postTitle" placeholder="Título (opcional)" maxlength="100">
            </div>
            <div class="form-group">
                <textarea id="postContent" placeholder="Contenido del mensaje" required maxlength="2000"></textarea>
            </div>
            <div class="form-group">
                <input type="file" id="postImage" accept="image/*">
            </div>
            <button onclick="createPost()">Publicar</button>
        </div>
        
        <div id="threads"></div>
        
        <div id="githubConfig" class="post-form" style="display: none;">
            <h3>Configuración GitHub</h3>
            <div class="form-group">
                <input type="text" id="githubToken" placeholder="Token de GitHub" required>
            </div>
            <div class="form-group">
                <input type="text" id="gistId" placeholder="ID del Gist (dejar vacío para crear uno nuevo)">
            </div>
            <button onclick="saveConfig()">Guardar Configuración</button>
        </div>
    </div>

    <script>  
   class ChanBoard {
    constructor() {
        this.githubToken = localStorage.getItem('githubToken');
        this.gistId = localStorage.getItem('gistId');
        this.posts = [];
        this.init();
    }

    async init() {
        if (!this.githubToken) {
            this.showConfigForm();
            return;
        }

        if (this.gistId) {
            await this.loadPosts();
            this.renderPosts();
        } else {
            this.showConfigForm();
        }
    }

    showConfigForm() {
        document.getElementById('githubConfig').style.display = 'block';
        if (this.githubToken) {
            document.getElementById('githubToken').value = this.githubToken;
        }
        if (this.gistId) {
            document.getElementById('gistId').value = this.gistId;
        }
    }

    async saveConfig() {
        const token = document.getElementById('githubToken').value.trim();
        const gistId = document.getElementById('gistId').value.trim();

        if (!token) {
            this.showMessage('Por favor ingresa un token de GitHub', 'error');
            return;
        }

        this.githubToken = token;
        localStorage.setItem('githubToken', token);

        if (gistId) {
            this.gistId = gistId;
            localStorage.setItem('gistId', gistId);
            await this.loadPosts();
            document.getElementById('githubConfig').style.display = 'none';
            this.showMessage('Configuración guardada correctamente', 'success');
        } else {
            await this.createGist();
        }
    }

    async createGist() {
        try {
            this.showMessage('Creando nuevo Gist...', 'success');
            
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.githubToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    description: 'ChanBoard - Publicaciones anónimas',
                    public: false,
                    files: {
                        'posts.json': {
                            content: JSON.stringify([], null, 2)
                        }
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Error creando Gist');
            }

            const data = await response.json();
            this.gistId = data.id;
            localStorage.setItem('gistId', data.id);
            
            document.getElementById('githubConfig').style.display = 'none';
            this.showMessage('Gist creado correctamente', 'success');
            
        } catch (error) {
            console.error('Error creando Gist:', error);
            this.showMessage('Error al crear el Gist: ' + error.message, 'error');
        }
    }

    async loadPosts() {
        try {
            if (!this.gistId) {
                console.log('No hay Gist ID configurado');
                return;
            }

            console.log('Cargando posts del Gist:', this.gistId);
            
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                headers: {
                    'Authorization': `Bearer ${this.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Gist no encontrado. Verifica el ID o crea uno nuevo.');
                }
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const gist = await response.json();
            console.log('Gist cargado:', gist);
            
            const content = gist.files['posts.json'].content;
            console.log('Contenido del archivo:', content);
            
            this.posts = JSON.parse(content) || [];
            console.log('Posts cargados:', this.posts);
            
        } catch (error) {
            console.error('Error cargando posts:', error);
            this.showMessage('Error cargando posts: ' + error.message, 'error');
            
            // Si hay error, mostrar formulario de configuración
            if (error.message.includes('no encontrado') || error.message.includes('404')) {
                this.gistId = null;
                localStorage.removeItem('gistId');
                this.showConfigForm();
            }
        }
    }

    async savePosts() {
        try {
            console.log('Guardando posts...', this.posts);
            
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${this.githubToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    description: 'ChanBoard - Publicaciones anónimas',
                    files: {
                        'posts.json': {
                            content: JSON.stringify(this.posts, null, 2)
                        }
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Error guardando posts');
            }

            console.log('Posts guardados correctamente');
            return true;
            
        } catch (error) {
            console.error('Error guardando posts:', error);
            this.showMessage('Error guardando posts: ' + error.message, 'error');
            throw error;
        }
    }

    async createPost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        const imageInput = document.getElementById('postImage');
        
        if (!content.trim()) {
            this.showMessage('El contenido no puede estar vacío', 'error');
            return;
        }

        // Validar que tenemos configuración
        if (!this.githubToken || !this.gistId) {
            this.showMessage('Primero configura tu token de GitHub', 'error');
            this.showConfigForm();
            return;
        }

        let imageData = null;
        if (imageInput.files[0]) {
            // Validar tamaño de imagen (máximo 1MB)
            if (imageInput.files[0].size > 1024 * 1024) {
                this.showMessage('La imagen no puede ser mayor a 1MB', 'error');
                return;
            }
            imageData = await this.convertImageToBase64(imageInput.files[0]);
        }

        const post = {
            id: Date.now().toString(),
            title: title || '',
            content: content,
            image: imageData,
            timestamp: new Date().toISOString(),
            replies: []
        };

        console.log('Creando nuevo post:', post);
        this.posts.unshift(post); // Agregar al inicio del array
        
        try {
            await this.savePosts();
            this.renderPosts();
            this.clearForm();
            this.showMessage('Publicación creada correctamente', 'success');
        } catch (error) {
            // Revertir si hay error
            this.posts.shift();
            this.showMessage('Error al guardar la publicación', 'error');
        }
    }

    async addReply(threadId, content) {
        if (!content.trim()) {
            this.showMessage('La respuesta no puede estar vacía', 'error');
            return;
        }

        const reply = {
            id: Date.now().toString(),
            content: content,
            timestamp: new Date().toISOString()
        };

        const thread = this.posts.find(p => p.id === threadId);
        if (thread) {
            thread.replies.push(reply);
            
            try {
                await this.savePosts();
                this.renderPosts();
                this.showMessage('Respuesta agregada', 'success');
            } catch (error) {
                thread.replies.pop();
                this.showMessage('Error al guardar la respuesta', 'error');
            }
        }
    }

    convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    renderPosts() {
        const threadsContainer = document.getElementById('threads');
        
        if (!threadsContainer) {
            console.error('No se encontró el contenedor de threads');
            return;
        }

        threadsContainer.innerHTML = '';

        if (this.posts.length === 0) {
            threadsContainer.innerHTML = `
                <div class="thread">
                    <div class="post">
                        <div class="post-content">
                            No hay publicaciones aún. ¡Sé el primero en postear!
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        console.log('Renderizando', this.posts.length, 'posts');
        
        this.posts.forEach(post => {
            const threadElement = this.createThreadElement(post);
            threadsContainer.appendChild(threadElement);
        });
    }

    createThreadElement(post) {
        const threadDiv = document.createElement('div');
        threadDiv.className = 'thread';
        threadDiv.innerHTML = `
            <div class="post">
                <div class="post-header">
                    <strong>Anónimo</strong> • ${new Date(post.timestamp).toLocaleString()}
                    <span style="float: right; color: #789922;">#${post.id.slice(-6)}</span>
                </div>
                ${post.title ? `<div style="font-weight: bold; color: #0f0c5d; margin-bottom: 8px; font-size: 18px;">${this.escapeHtml(post.title)}</div>` : ''}
                <div class="post-content">${this.formatContent(post.content)}</div>
                ${post.image ? `<img src="${post.image}" class="post-image" alt="Imagen adjunta" style="max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #b7c5d9;">` : ''}
            </div>
            
            <div class="replies">
                ${post.replies.map(reply => this.createReplyElement(reply)).join('')}
            </div>
            
            <div class="reply-form">
                <textarea id="reply-${post.id}" placeholder="Responder a este hilo..." maxlength="1000" style="width: 100%; margin-bottom: 5px;"></textarea>
                <button onclick="chanBoard.addReply('${post.id}', document.getElementById('reply-${post.id}').value)">Responder</button>
            </div>
        `;
        return threadDiv;
    }

    createReplyElement(reply) {
        return `
            <div class="post" style="margin-top: 10px; margin-left: 20px; border-left: 3px solid #789922; padding-left: 10px;">
                <div class="post-header">
                    <strong>Anónimo</strong> • ${new Date(reply.timestamp).toLocaleString()}
                </div>
                <div class="post-content">${this.formatContent(reply.content)}</div>
            </div>
        `;
    }

    formatContent(content) {
        if (!content) return '';
        
        // Escapar HTML primero
        let formatted = this.escapeHtml(content);
        
        // Convertir URLs en enlaces
        const urlRegex = /(https?:\/\/[^\s<]+)/g;
        formatted = formatted.replace(urlRegex, '<a href="$1" target="_blank" style="color: #117743;">$1</a>');
        
        // Convertir saltos de línea en <br>
        formatted = formatted.replace(/\n/g, '<br>');
        
        return formatted;
    }

    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    clearForm() {
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
        document.getElementById('postImage').value = '';
    }

    showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        if (!messageDiv) {
            console.log(`[${type}] ${message}`);
            return;
        }
        
        messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }

    // Método para debug
    debug() {
        console.log('Token:', this.githubToken ? '✓ Configurado' : '✗ No configurado');
        console.log('Gist ID:', this.gistId || '✗ No configurado');
        console.log('Posts:', this.posts);
    }
}

// Instanciar la aplicación
const chanBoard = new ChanBoard();

// Funciones globales para los botones
function saveConfig() {
    chanBoard.saveConfig();
}

function createPost() {
    chanBoard.createPost();
}

// Debug en consola
window.debugChanBoard = () => chanBoard.debug();    
    </script>
</body>
</html>
