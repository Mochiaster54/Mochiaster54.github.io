<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChanBoard - Anónimo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #eef2ff;
            color: #000;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #800080;
            color: white;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: bold;
        }
        
        .post-form {
            background-color: #d6daf0;
            border: 1px solid #b7c5d9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #b7c5d9;
            border-radius: 4px;
            background-color: white;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #800080;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #6a006a;
        }
        
        .thread {
            background-color: #d6daf0;
            border: 1px solid #b7c5d9;
            margin-bottom: 20px;
            border-radius: 4px;
            padding: 15px;
        }
        
        .post {
            background-color: white;
            border: 1px solid #b7c5d9;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .post-header {
            color: #117743;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .post-content {
            margin-bottom: 10px;
        }
        
        .post-image {
            max-width: 200px;
            max-height: 200px;
            margin: 5px 0;
        }
        
        .replies {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .reply-form {
            margin-top: 10px;
            padding: 10px;
            background-color: #eef2ff;
            border-radius: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: red;
            background-color: #ffd6d6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .success {
            color: green;
            background-color: #d6ffd6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <p>token: ghp_KKmFfhezNvJaIvrCHBV9ufOWBWaQ1i0HFcW</p><p>v</p>
    <p>gits: 249dd1417f372f7a170eaf6f8e058cf2</p>
    <header>
        <div class="header-content">
            <h1>ChanBoard - Publicaciones anónimas</h1>
        </div>
    </header>
    
    <div class="container">
        <div id="message"></div>
        
        <div class="post-form">
            <h3>Nuevo Hilo</h3>
            <div class="form-group">
                <input type="text" id="postTitle" placeholder="Título (opcional)" maxlength="100">
            </div>
            <div class="form-group">
                <textarea id="postContent" placeholder="Contenido del mensaje" required maxlength="2000"></textarea>
            </div>
            <div class="form-group">
                <input type="file" id="postImage" accept="image/*">
            </div>
            <button onclick="createPost()">Publicar</button>
        </div>
        
        <div id="threads"></div>
        
        <div id="githubConfig" class="post-form" style="display: none;">
            <h3>Configuración GitHub</h3>
            <div class="form-group">
                <input type="text" id="githubToken" placeholder="Token de GitHub" required>
            </div>
            <div class="form-group">
                <input type="text" id="gistId" placeholder="ID del Gist (dejar vacío para crear uno nuevo)">
            </div>
            <button onclick="saveConfig()">Guardar Configuración</button>
        </div>
    </div>

    <script>
        class ChanBoard {
    constructor() {
        this.githubToken = localStorage.getItem('githubToken');
        this.gistId = localStorage.getItem('gistId');
        this.posts = [];
        this.init();
    }

    async init() {
        if (!this.githubToken || !this.gistId) {
            this.showConfigForm();
        } else {
            await this.loadPosts();
            this.renderPosts();
        }
    }

    showConfigForm() {
        document.getElementById('githubConfig').style.display = 'block';
    }

    async saveConfig() {
        const token = document.getElementById('githubToken').value;
        const gistId = document.getElementById('gistId').value;

        if (!token) {
            this.showMessage('Por favor ingresa un token de GitHub', 'error');
            return;
        }

        this.githubToken = token;
        this.gistId = gistId;

        localStorage.setItem('githubToken', token);
        localStorage.setItem('gistId', gistId);

        if (!gistId) {
            await this.createGist();
        } else {
            await this.loadPosts();
        }

        document.getElementById('githubConfig').style.display = 'none';
        this.showMessage('Configuración guardada correctamente', 'success');
    }

    async createGist() {
        try {
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${this.githubToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    description: 'ChanBoard - Publicaciones anónimas',
                    public: false,
                    files: {
                        'posts.json': {
                            content: JSON.stringify([])
                        }
                    }
                })
            });

            if (!response.ok) throw new Error('Error creando Gist');

            const data = await response.json();
            this.gistId = data.id;
            localStorage.setItem('gistId', data.id);
            
        } catch (error) {
            this.showMessage('Error al crear el Gist: ' + error.message, 'error');
        }
    }

    async loadPosts() {
        try {
            if (!this.gistId) return;

            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                headers: {
                    'Authorization': `token ${this.githubToken}`,
                }
            });

            if (!response.ok) throw new Error('Error cargando posts');

            const gist = await response.json();
            const content = gist.files['posts.json'].content;
            this.posts = JSON.parse(content) || [];
            
        } catch (error) {
            this.showMessage('Error cargando posts: ' + error.message, 'error');
        }
    }

    async savePosts() {
        try {
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${this.githubToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    files: {
                        'posts.json': {
                            content: JSON.stringify(this.posts, null, 2)
                        }
                    }
                })
            });

            if (!response.ok) throw new Error('Error guardando posts');
            
        } catch (error) {
            this.showMessage('Error guardando posts: ' + error.message, 'error');
            throw error;
        }
    }

    async createPost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        const imageInput = document.getElementById('postImage');
        
        if (!content.trim()) {
            this.showMessage('El contenido no puede estar vacío', 'error');
            return;
        }

        let imageData = null;
        if (imageInput.files[0]) {
            imageData = await this.convertImageToBase64(imageInput.files[0]);
        }

        const post = {
            id: Date.now().toString(),
            title: title || 'Sin título',
            content: content,
            image: imageData,
            timestamp: new Date().toISOString(),
            replies: []
        };

        this.posts.unshift(post);
        
        try {
            await this.savePosts();
            this.renderPosts();
            this.clearForm();
            this.showMessage('Publicación creada correctamente', 'success');
        } catch (error) {
            this.posts.shift(); // Revertir si hay error
        }
    }

    async addReply(threadId, content) {
        const reply = {
            id: Date.now().toString(),
            content: content,
            timestamp: new Date().toISOString()
        };

        const thread = this.posts.find(p => p.id === threadId);
        if (thread) {
            thread.replies.push(reply);
            
            try {
                await this.savePosts();
                this.renderPosts();
            } catch (error) {
                thread.replies.pop(); // Revertir si hay error
            }
        }
    }

    convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    renderPosts() {
        const threadsContainer = document.getElementById('threads');
        threadsContainer.innerHTML = '';

        if (this.posts.length === 0) {
            threadsContainer.innerHTML = '<div class="post">No hay publicaciones aún. ¡Sé el primero en postear!</div>';
            return;
        }

        this.posts.forEach(post => {
            const threadElement = this.createThreadElement(post);
            threadsContainer.appendChild(threadElement);
        });
    }

    createThreadElement(post) {
        const threadDiv = document.createElement('div');
        threadDiv.className = 'thread';
        threadDiv.innerHTML = `
            <div class="post">
                <div class="post-header">
                    Anónimo • ${new Date(post.timestamp).toLocaleString()}
                    <span style="float: right;">#${post.id.slice(-4)}</span>
                </div>
                ${post.title ? `<div style="font-weight: bold; margin-bottom: 5px;">${this.escapeHtml(post.title)}</div>` : ''}
                <div class="post-content">${this.formatContent(post.content)}</div>
                ${post.image ? `<img src="${post.image}" class="post-image" alt="Imagen adjunta">` : ''}
            </div>
            <div class="replies" id="replies-${post.id}">
                ${post.replies.map(reply => this.createReplyElement(reply)).join('')}
            </div>
            <div class="reply-form">
                <textarea id="reply-${post.id}" placeholder="Responder a este hilo..." maxlength="1000"></textarea>
                <button onclick="chanBoard.addReply('${post.id}', document.getElementById('reply-${post.id}').value)">Responder</button>
            </div>
        `;
        return threadDiv;
    }

    createReplyElement(reply) {
        return `
            <div class="post">
                <div class="post-header">
                    Anónimo • ${new Date(reply.timestamp).toLocaleString()}
                </div>
                <div class="post-content">${this.formatContent(reply.content)}</div>
            </div>
        `;
    }

    formatContent(content) {
        // Convertir URLs en enlaces
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        let formatted = this.escapeHtml(content).replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
        
        // Convertir saltos de línea en <br>
        formatted = formatted.replace(/\n/g, '<br>');
        
        return formatted;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    clearForm() {
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
        document.getElementById('postImage').value = '';
    }

    showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }
}

// Instanciar la aplicación
const chanBoard = new ChanBoard();

// Funciones globales para los botones
function saveConfig() {
    chanBoard.saveConfig();
}

function createPost() {
    chanBoard.createPost();
}
    </script>
</body>
</html>
